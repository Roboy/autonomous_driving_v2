
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>angle_sensor_calibration &#8212; beginner_tutorials 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for angle_sensor_calibration</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">rospkg</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../roboy_communication/roboy_middleware_msgs/msgs&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">roboy_middleware_msgs.msg</span> <span class="k">import</span> <span class="n">MotorAngle</span>

<div class="viewcode-block" id="AngleSensorCalibration"><a class="viewcode-back" href="../angle_sensor_calibration.html#angle_sensor_calibration.AngleSensorCalibration">[docs]</a><span class="k">class</span> <span class="nc">AngleSensorCalibration</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Class to calibrate an angle sensor and store the calibration it a yaml config file.</span>
<span class="sd">    Usage:</span>
<span class="sd">    Its intended use is for the angle sensor on the rickshaw.</span>
<span class="sd">    It guides the user through the calibration process. The dafault process consist of three steps. The user has to manually move the rickshaw into three positions (he can use the default angle value or define new ones) and then this ROS-node will listen to a given number of messages by the angle sensor and average over them. This process includes three steps to ensure, that the middle position of the rickshaw has the correct angle. The other two point determine the resolution of the angle sensor.</span>
<span class="sd">    This code can be modified for a different calibration process, furthermore sanitiy should be included. E.g. is the middle angle approx. in the middle of the other two angles.</span>

<span class="sd">    ...</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    num_msgs : int</span>
<span class="sd">        number of messages the class listens to and averages over</span>
<span class="sd">    rate : int</span>
<span class="sd">        freuquency of how often the listener checks for new messages</span>
<span class="sd">    target_angles : list of str</span>
<span class="sd">        points defined by the user, to which to steer the rickshaw to</span>
<span class="sd">    default_angles: dict of int</span>
<span class="sd">        degree values of the points defined by the user</span>
<span class="sd">    pkg_path: str</span>
<span class="sd">        path to the roboy_navigation package, needed for writing data into config file</span>
<span class="sd">    angles: dict of int</span>
<span class="sd">        actual chosen angle values by the user</span>
<span class="sd">    raw: dict of int</span>
<span class="sd">        average of the respective sensor angle values</span>
<span class="sd">        </span>

<span class="sd">    Methods</span>
<span class="sd">    ----------</span>
<span class="sd">    start()</span>
<span class="sd">        starts the calibration process</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_msgs</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param num_msgs: number of messages to average over (default: 100)</span>
<span class="sd">        :type num_msgs: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_msgs</span> <span class="o">=</span> <span class="n">num_msgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_angles</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_angles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">middle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="n">right</span> <span class="o">=</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span>
                                   <span class="n">left</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_path</span> <span class="o">=</span> <span class="n">rospkg</span><span class="o">.</span><span class="n">RosPack</span><span class="p">()</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;roboy_navigation&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="AngleSensorCalibration.start"><a class="viewcode-back" href="../angle_sensor_calibration.html#angle_sensor_calibration.AngleSensorCalibration.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the calibration process. Listens to messages of the angle sensor.</span>
<span class="sd">        Writes the collected data into a yaml file in the config directory.</span>
<span class="sd">        :returns: nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;angle_calibration&#39;</span><span class="p">,</span> <span class="n">anonymous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Rate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_angles</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Move the rickshaw to the </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">input_angle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Which angle is this? </span><span class="se">\n</span><span class="s1"> Please specify the angle. If you want to take the maximum angle of </span><span class="si">{}</span><span class="s1"> press enter &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_angles</span><span class="p">[</span><span class="n">angle</span><span class="p">])))</span>
            <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="ow">or</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Going on with default value.&#39;</span><span class="p">)</span>
                <span class="n">input_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_angles</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;If rickshaw is in position press Enter...&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hold in place&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_angle</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_msgs</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_message</span><span class="p">(</span><span class="s1">&#39;/roboy/middleware/SteeringAngle&#39;</span><span class="p">,</span> <span class="n">MotorAngle</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">raw_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">rate</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
            <span class="n">collected_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">raw_angle</span> <span class="o">=</span> <span class="s1">&#39;raw_&#39;</span> <span class="o">+</span> <span class="n">angle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">[</span><span class="n">raw_angle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">collected_data</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You can release the rickshaw.&#39;</span><span class="p">)</span>
        <span class="n">calibration</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span>
                           <span class="n">angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_path</span><span class="p">,</span> <span class="s1">&#39;config/calibration.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ymlfile</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">calibration</span><span class="p">,</span> <span class="n">ymlfile</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">AngleSensorCalibration</span><span class="p">(</span><span class="n">num_msgs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
  
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">beginner_tutorials</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, DominikMuhle.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>